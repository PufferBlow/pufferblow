services:
  pufferblow-server:
    build:
      context: .
      dockerfile: Dockerfile.prod
    container_name: pufferblow-server
    restart: unless-stopped
    ports:
      - "7575:7575"
    environment:
      PUFFERBLOW_DATABASE_URI: ${PUFFERBLOW_DATABASE_URI:-}
      PUFFERBLOW_API_HOST: ${PUFFERBLOW_API_HOST:-0.0.0.0}
      PUFFERBLOW_API_PORT: ${PUFFERBLOW_API_PORT:-7575}
    volumes:
      - pufferblow_data:/root/.pufferblow
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - pufferblow-server-net

  media-sfu:
    build:
      context: ${MEDIA_SFU_GIT_CONTEXT:-https://github.com/pufferblow/media-sfu.git}
      dockerfile: Dockerfile
    container_name: pufferblow-media-sfu
    restart: unless-stopped
    ports:
      - "8787:8787"
      - "${RTC_UDP_PORT_MIN:-50000}-${RTC_UDP_PORT_MAX:-50199}:${RTC_UDP_PORT_MIN:-50000}-${RTC_UDP_PORT_MAX:-50199}/udp"
    environment:
      RTC_BIND_ADDR: ":8787"
      RTC_BOOTSTRAP_CONFIG_URL: http://pufferblow-server:7575/api/internal/v1/voice/bootstrap-config
      RTC_BOOTSTRAP_SECRET: ${RTC_BOOTSTRAP_SECRET}
      RTC_BOOTSTRAP_HTTP_TIMEOUT: ${RTC_BOOTSTRAP_HTTP_TIMEOUT:-5s}
    depends_on:
      - pufferblow-server
    networks:
      - pufferblow-server-net

  coturn:
    image: instrumentisto/coturn:4.6.3
    container_name: pufferblow-coturn
    restart: unless-stopped
    command: >
      -n
      --log-file=stdout
      --listening-port=3478
      --realm=${TURN_REALM:-pufferblow.space}
      --user=${PUFFERBLOW_TURN_USERNAME:-pufferblow}:${PUFFERBLOW_TURN_PASSWORD}
      --fingerprint
      --lt-cred-mech
      --no-multicast-peers
      --min-port=49160
      --max-port=49200
    ports:
      - "3478:3478/tcp"
      - "3478:3478/udp"
      - "49160-49200:49160-49200/udp"
    networks:
      - pufferblow-server-net

  postgres:
    image: postgres:16-alpine
    container_name: pufferblow-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-pufferblow}
      POSTGRES_USER: ${POSTGRES_USER:-pufferblow}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - pufferblow_postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-pufferblow} -d ${POSTGRES_DB:-pufferblow}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - pufferblow-server-net

volumes:
  pufferblow_data:
  pufferblow_postgres:

networks:
  pufferblow-server-net:
    driver: bridge
